<!DOCTYPE html> 
<html>
<head>
<meta charset=utf-8>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="application-name" content="TVHadmin">
<title>TVHadmin - Timeline</title>
<link rel="stylesheet" href="style.css">
<script src="include.js"></script>
<script>
  window.addEventListener('load',function() {
    var mytop=document.getElementById("mobmenu");
    mytop.addEventListener('click', function() {
        var mynav=document.getElementById("navigation");
        if (mynav.classList.contains('focus'))
            mynav.classList.remove('focus');
        else mynav.classList.add('focus');
    });
  },false);

  function click_tag(prefix, tagID) {
    var chk;
    if (document.getElementById(tagID).checked) chk = 1;
    else chk = -1;
    sessionStorage.setItem((prefix+tagID), chk);
    location.reload();
  }
</script>
</head> 
<body>
<div id="container">
  <div id="navigation">
    <div class="logo">
      <img src="images/logo.png" alt="TVHeadend Logo" width="150">
    </div>
    <div class="nav_bar">
    <div class="navi"><a href="now.html">What's On Now</a></div>
    <div class="navi"><a href="timeline.html">Timeline</a></div>
    <div class="navi"><a href="channels.html">Channels</a></div>
    <div class="navi"><a href="favourites.html">Favourite Channels</a></div>
    <div class="navi"><a href="timers.html">Timers</a></div>
    <div class="navi"><a href="recordings.html">Recordings</a></div>
    <div class="navi"><a href="links.html">Series Links</a></div>
    <div class="navi"><a href="status.html">Status</a></div>
    <div class="navi"><a href="config.html">Configuration</a></div>
      <form action="search.html" method="GET" name="telly" class="search">
        <input type="text" name="find"><br>
        <input type="submit" name="submit" value="Search">
      </form>
    </div>
  </div>
    <div id='layout'>
      <div id='banner'>
        <table>
          <tr>
	    <td class='col_title'><div id='mobmenu'>&#9776;</div> <h1>Timeline</h1></td>
	    <td id='mediatags'></td>
	    <td id='arrows'></td>
	  </tr>
        </table>
      </div>
      <div id='wrapper'>
        <div id='timeline'>
	  <table class='list' id='list' style='table-layout: fixed;'>
	    <colgroup>
	      <col id='channelname'>
	      <col id='schedules'>
	    </colgroup>
	    <tr class='newday' id='newday'>
	    </tr>
	  </table>
	  <span id='timenow' style='visibility: hidden'>
	    <img src='images/spacer.gif' width='1' height='1' alt=''>
	  </span>
	</div>
      </div>
   </div>
  </div>
<script>
  async function main() {
    const cookies = get_cookies();
    var tags = await get_channeltags();
    var s = "<span class='wideonly'>";
    var media = [];
    for (var key in cookies) {
      if (key.startsWith("Tag_")) {
	var tag = decodeURIComponent(key.substring(4));
	s += "<div class='media'>" +
		`<label for='${tag}'>${tag}:</label>` +
		`<input type='checkbox' name='${tag}' id='${tag}' onchange='click_tag("Tim_", "${tag}")'`;
	if (sessionStorage.getItem("Tim_"+tag)) {
	  if (sessionStorage.getItem("Tim_"+tag) == 1) {
	    s += " checked";
	    media[tags[tag]] = 1;
	  }
	}
	else if (cookies[("Tim_"+tag)]) {
	  s += " checked";
	  media[tags[tag]] = 1;
	}
	s += "></div>";
      }
    }
    s += "</span>";
    document.getElementById("mediatags").innerHTML = s;

    const now = Math.floor(Date.now() / 1000);
    var textent = 14400;
    if (cookies.TIMESPAN) textent = cookies.TIMESPAN * 3600;
    var utime = now;
    const query = window.location.search;
    const params = new URLSearchParams(query);
    if (params.has('start')) {
      utime = Math.max(now, params.get('start'));
    }
    var toffset = utime % 1800;
    var tstart = utime - toffset;
    var tend = tstart + textent;
    var tnext = tend;
    var wday = strftime('%A %e %b', utime);
    let tleft = utime - textent/2, tright = utime + textent/2;
    s = `<a href='timeline.html?start=${tleft}' ><img src='images/left.png' alt='Go Back' title='left'></a>&nbsp;` +
	`<a href='timeline.html?start=${tright}' ><img src='images/right.png' alt='Go Forward' title='right'></a>`;
    document.getElementById("arrows").innerHTML = s;

    if (cookies.CSORT == 1) {
      var lcn = 1;
      var ch_width = 145;
    }
    else {
      var lcn = 0;
      var ch_width = 120;
    }
    document.getElementById('channelname').style = `width: ${ch_width}px`;
    s = `<td>${wday}</td><td>`;
    var t = tstart;
    var colours = ['#ffffff', '#dee6ee', '#ffffff', '#dee6ee'];
    for(i=0; i<4; i++) {
      let time = strftime('%H:%M', t);
      s += `<div style='float: left; background-color: ${colours[i]}; width: 24.5%;'>${time}</div>`;
      t += textent / 4;
    }
    s += '</td>';
    document.getElementById('newday').innerHTML = s;

    var channels = await get_channels(lcn);
    var tags = await get_channeltags();
    var events = await get_epg('', tstart, tend);
    var table = document.getElementById("list");
    var i = 0;
    for (const c of channels) {
      if (!(media.All)) {
	if (intersect(c.tags, media) == 0) continue;
      }
      if (lcn) var name = `${c.number} ${c.name}`;
      else var name = c.name;
      let row = table.insertRow(-1);
      var e = events.filter(m => m.channelUuid === c.uuid);
      if (e) {
        var wd = 98 - e.length/8;
	s = `<td class='col_channel'><div class='channel_name' style='background-color: ${colours[i%2]}'>${name}</div></td><td class='col_schedule'>`;
	for (const p of e) {
	  if (p.start <= now && p.stop > now) {
	    if (p.start > tstart) {	//Need a spacer
	      spc = ((p.start - tstart) * wd) / textent;
	      s += `<div class='spacer' style='width: ${spc}%;'> <img src='images/spacer.gif' width=1 height=1 alt=''></div>`;
	    }
	    var colour = '#b4e29c';
	    tnext = Math.min(tnext, p.stop);
	  }
	  else var colour = '#dee6ee';
	  var duration = Math.min(tend, p.stop) - Math.max(tstart, p.start);
	  if (duration == 0) continue;
	  var pc = (wd * duration) / textent;
	  if (p.summary) var desc = p.summary;
	  else if (p.description) var desc = p.description;
	  else var desc = "";
	  var subtitle = htmlspecialchars(desc);
	  s += `<div class='item' style='background-color: ${colour}; width: ${pc}%;' title='${subtitle}'>${p.title}</div>`;
	}
	s += "</td>";
	row.innerHTML = s;
      }
      i++;
    }

    if (cookies.REFR) var refresh = 1;
    else var refresh = 0;
    drawCursor(refresh);

//	These functions are inside main() to access its variables.
    var globalResizeTimer = null;
    window.onresize = function() {
      if(globalResizeTimer != null) window.clearTimeout(globalResizeTimer);
      globalResizeTimer = window.setTimeout(drawCursor, 200, refresh);
    };
    function drawCursor(refresh) {
      var time = Date.now()/1000;
      if(time > tnext) {
	location.reload(true);
      }
      var cursor = document.getElementById('timenow');
      if((time >= tstart) && (time < tend)) {
	var elem = document.getElementById('timeline');
	var rect = elem.getBoundingClientRect();
	var start = Math.max(0,6+rect.top);
	cursor.style.top = (start+27) + 'px';
	cursor.style.height = (rect.height-start) + 'px';
	var delta = (time%1800)/textent;
	var pos = rect.left + 6 + ch_width
		+ 0.98*delta*(rect.width-ch_width-6);
	cursor.style.left = pos + 'px';
        cursor.style.visibility = 'visible';
      }
      if(refresh == 1) {
	var sync = (time % 60) * 1000;
	var x = setTimeout(drawCursor, 63000-sync, 1);  // Avoid race
      }
    }
  }
  main();
</script>
 </body>
</html>
